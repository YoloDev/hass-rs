name: CI

on:
  - push
  - pull_request

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      # Always run main branch builds to completion.
      fail-fast: ${{ github.event_name == 'pull_request' ||
        (github.ref != 'refs/heads/main' &&
        !startsWith(github.ref, 'refs/tags/')) }}
      matrix:
        os:
          - macos-latest
          # - windows-latest
          - ubuntu-latest
        channel:
          - stable
          # - beta
          - nightly

    env:
      TERM: xterm-256color

    steps:
      - name: Configure git
        run: |
          git config --global core.autocrlf false
          git config --global core.symlinks true
          git config --global fetch.parallel 32

      - uses: awalsh128/cache-apt-pkgs-action@v1
        if: matrix.os == 'ubuntu-latest'
        with:
          packages: libpaho-mqtt-dev
          version: 1.0

      - uses: dsaltares/fetch-gh-release-asset@v1
        if: matrix.os == 'macos-latest'
        with:
          repo: eclipse/paho.mqtt.c
          file: "Eclipse-Paho-MQTT-C-\\d+\\.\\d+\\.\\d+-Darwin\\.tar\\.gz\\.zip"
          regex: true

      - name: Unzip and install Paho C
        if: matrix.os == 'macos-latest'
        run: |
          unzip Eclipse-Paho-MQTT-C-*-Darwin.tar.gz.zip
          tar -xzf Eclipse-Paho-MQTT-C-*-Darwin.tar.gz
          sudo cp -r Eclipse-Paho-MQTT-C-*-Darwin/include /usr/local/include
          sudo cp -r Eclipse-Paho-MQTT-C-*-Darwin/lib /usr/local/lib

      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.channel }}
          components: clippy
      - uses: Swatinem/rust-cache@v2

      - name: Clippy
        run: cargo clippy --all-features -- -D warnings

      - name: Install cargo-all-features
        run: cargo install cargo-featurex

      - name: Run check (all feature permutations)
        run: cargo featurex clippy

      - name: Run tests (all feature permutations)
        run: cargo featurex test
